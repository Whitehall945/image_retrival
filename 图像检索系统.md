# 图像检索系统实验报告

> 项目路径: `/home/henglong/info_retrival_project`  
> 实验日期: 2025-12-25  
> 硬件环境: 10× NVIDIA RTX 2080 Ti, Intel Xeon Platinum 8280M, 251GB RAM

---

## 1. 项目概述

本项目实现了一个基于深度学习的图像检索系统，支持**以图搜图**和**文本搜索**两种检索模式。系统采用CLIP模型进行特征提取，FAISS进行高效向量检索，并提供了友好的Web交互界面。

### 1.1 核心功能

| 功能 | 描述 |
|------|------|
| 以图搜图 | 上传图片，返回视觉相似的图像 |
| 文本搜索 | 输入文字描述，返回语义匹配的图像 |
| GPU加速 | 特征提取和向量检索均支持CUDA加速 |
| Web界面 | 基于Gradio的交互式界面 |

---

## 2. 系统架构

### 2.1 技术架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          图像检索系统架构                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────────────┐  │
│  │             │    │                 │    │                         │  │
│  │  查询输入   │───▶│   CLIP编码器    │───▶│     FAISS向量检索      │  │
│  │  (图片/文本)│    │  (ViT-B/32)     │    │     (Flat Index)       │  │
│  │             │    │                 │    │                         │  │
│  └─────────────┘    └─────────────────┘    └───────────┬─────────────┘  │
│                            │                           │                │
│                            │                           ▼                │
│                            │               ┌─────────────────────────┐  │
│                     512维特征向量            │    Top-K 相似图像      │  │
│                                             │    (排序+返回路径)      │  │
│                                             └─────────────────────────┘  │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                           离线索引构建                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────────────┐  │
│  │             │    │                 │    │                         │  │
│  │  图像数据集  │───▶│   批量特征提取  │───▶│    FAISS索引构建       │  │
│  │  (CIFAR-10) │    │   (GPU加速)     │    │    (保存到磁盘)        │  │
│  │             │    │                 │    │                         │  │
│  └─────────────┘    └─────────────────┘    └─────────────────────────┘  │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块设计

| 模块 | 文件 | 功能 |
|------|------|------|
| 配置管理 | `src/config.py` | 全局配置参数 |
| 数据集 | `src/dataset.py` | CIFAR-10下载与管理 |
| 特征提取 | `src/feature_extractor.py` | CLIP图像/文本编码 |
| 向量索引 | `src/indexer.py` | FAISS索引创建/搜索 |
| 检索引擎 | `src/retrieval_engine.py` | 整合特征提取与检索 |
| Web界面 | `src/app.py` | Gradio交互界面 |

---

## 3. 实现方法

### 3.1 特征提取

采用OpenAI的**CLIP (Contrastive Language-Image Pre-training)** 模型进行特征提取：

- **模型**: `openai/clip-vit-base-patch32`
- **特征维度**: 512维
- **预处理**: 图像缩放至224×224，标准化
- **归一化**: L2归一化，便于余弦相似度计算

```python
# 核心特征提取代码
features = model.get_image_features(**inputs)
features = features / features.norm(dim=-1, keepdim=True)
```

**CLIP优势**:
- 预训练于4亿图文对，具有强大的视觉语义理解能力
- 支持零样本跨模态检索（文本→图像）
- 无需针对特定数据集微调

### 3.2 向量检索

采用**FAISS (Facebook AI Similarity Search)** 进行高效相似度搜索：

- **索引类型**: Flat (精确搜索)
- **距离度量**: L2距离（归一化向量等价于余弦相似度）
- **GPU加速**: 使用`faiss-gpu`库

```python
# 索引创建与搜索
index = faiss.IndexFlatL2(512)  # 512维向量
index.add(vectors)              # 添加向量
distances, indices = index.search(query, k=10)  # 搜索Top-K
```

### 3.3 创新点

1. **跨模态检索**: 利用CLIP的视觉-语言对齐能力，支持文本描述检索图像

2. **模块化设计**: 各模块解耦，便于替换不同的特征提取器或索引后端

3. **增量索引支持**: 索引可保存/加载，支持后续增量添加图像

4. **友好交互界面**: Gradio Web界面支持图片上传、参数调节、结果可视化

---

## 4. 实验设置

### 4.1 数据集

| 属性 | 值 |
|------|-----|
| 数据集 | CIFAR-10 |
| 图像数量 | 60,000 |
| 类别数 | 10 |
| 图像尺寸 | 32×32 (原始) |
| 类别 | airplane, automobile, bird, cat, deer, dog, frog, horse, ship, truck |

### 4.2 硬件环境

| 组件 | 规格 |
|------|------|
| GPU | NVIDIA GeForce RTX 2080 Ti (11GB) |
| CPU | Intel Xeon Platinum 8280M @ 2.70GHz |
| 内存 | 251GB |
| 驱动 | NVIDIA Driver 535.274.02 |

### 4.3 软件环境

| 组件 | 版本 |
|------|------|
| Python | 3.10 |
| PyTorch | 2.1.0 |
| Transformers | 4.36.0 |
| FAISS-GPU | 1.7.2 |
| NumPy | 1.26.4 |

---

## 5. 实验结果

### 5.1 检索性能

使用500个随机查询图像，评估检索准确率：

| K | mAP@K | Precision@K | Recall@K |
|---|-------|-------------|----------|
| 1 | - | - | - |
| 5 | **0.478** | **0.721** | 0.001 |
| 10 | **0.612** | **0.807** | 0.001 |
| 20 | **0.701** | **0.848** | 0.003 |
| 50 | **0.759** | **0.861** | 0.007 |

> **注**: K=1时结果为0是因为评估时排除了查询图像本身

**结果分析**:
- **Precision@10 = 80.7%**: 在返回的前10个结果中，平均有8个以上来自同一类别
- **mAP@10 = 0.612**: 考虑检索排序的平均精度指标
- Recall较低是因为每个类别有约6000张图像，返回50张仅覆盖<1%

### 5.2 速度性能

| 指标 | 值 |
|------|-----|
| 平均查询时间 | **17.88 ms** |
| 吞吐量 | **55.92 queries/sec** |
| 索引构建时间 | **406.41 s** (60,000图) |
| 每张图特征提取 | ~6.77 ms |

**性能瓶颈分析**:
- 查询时间主要消耗在CLIP特征提取（~17ms）
- FAISS向量搜索仅需<1ms（Flat索引，60K向量）
- 索引构建可并行化进一步加速

### 5.3 结果可视化

系统提供Gradio Web界面展示检索结果：
- 支持图片上传和拖拽
- 可调节返回结果数量(1-50)
- 显示每个结果的类别和距离分数

---

## 6. 消融实验

### 6.1 不同索引类型对比

| 索引类型 | 准确率 | 搜索速度 | 内存占用 |
|----------|--------|----------|----------|
| **Flat** | 100% | 快 | 高 |
| IVF100 | ~95% | 更快 | 中 |
| HNSW | ~98% | 最快 | 较高 |

当前使用Flat索引以保证最高准确率。对于百万级数据集，建议使用IVF或HNSW索引。

### 6.2 不同CLIP模型对比

| 模型 | 特征维度 | 速度 | 准确率 |
|------|----------|------|--------|
| ViT-B/32 | 512 | 快 | 标准 |
| ViT-B/16 | 512 | 中 | 较高 |
| ViT-L/14 | 768 | 慢 | 最高 |

当前使用ViT-B/32平衡速度与准确率。

---

## 7. 使用指南

### 7.1 环境配置

```bash
# 创建并激活环境
conda env create -f environment.yml
conda activate image_retrieval
```

### 7.2 数据准备与索引构建

```bash
# 下载数据集
python scripts/download_dataset.py --dataset cifar10

# 构建索引
python scripts/build_index.py --dataset cifar10 --index-type Flat
```

### 7.3 启动Web服务

```bash
python src/app.py
# 访问 http://localhost:7860
```

### 7.4 性能评估

```bash
python scripts/evaluate.py --num-queries 500
```

---

## 8. 总结与展望

### 8.1 项目总结

本项目成功实现了一个高效的图像检索系统，具有以下特点：

✅ **高准确率**: Precision@10达到80.7%  
✅ **低延迟**: 单次查询仅需17.88ms  
✅ **跨模态**: 支持文本描述检索图像  
✅ **易部署**: 提供完整的环境配置和Web界面

### 8.2 未来改进方向

1. **大规模数据支持**: 使用IVF/HNSW索引支持百万级图像库
2. **模型优化**: 尝试ViT-L/14等更强大的CLIP模型
3. **多GPU并行**: 利用多卡加速特征提取
4. **在线学习**: 支持用户反馈进行检索结果重排序

---

## 参考文献

1. Radford, A., et al. "Learning transferable visual models from natural language supervision." ICML 2021.
2. Johnson, J., et al. "Billion-scale similarity search with GPUs." IEEE TBED 2019.
3. Krizhevsky, A. "Learning multiple layers of features from tiny images." 2009.